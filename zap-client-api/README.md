# ZAP Client API

## Contents

- [Introduction](#introduction)
- [Usage](#usage)
- [API](#api)
    - [ZapInfo](#zapinfo)
    - [AuthenticationInfo](#authenticationinfo)
    - [AnalysisInfo](#analysisinfo)
    - [ZapReport](#zapreport)
- [Examples](#examples)

## Introduction

The ZAP Client API is a project built on top of the [ZAP Java API](https://github.com/zaproxy/zaproxy/wiki/ApiJava). It abstracts all the calls to ZAP's API, significantly simplifying the configuration and execution process for applications that want to use ZAP. Moreover, the ZAP Client API adds support for [CAS](http://jasig.github.io/cas/) authentication, not supported by default by ZAP or its API.

## Usage

To use the API, just add the following dependency to your project:

```xml
<dependency>
	<groupId>br.com.softplan.security.zap</groupId>
	<artifactId>zap-client-api</artifactId>
	<version>${zap.client.api.version}</version>
</dependency>
```

Available versions can be found [here](). TODO: add link to Maven Central when the artifact is available there.

## API

The API's main class is [`ZapClient`](zap-client-api/src/main/java/br/com/softplan/security/zap/api/ZapClient.java), which receives an instance of [`ZapInfo`](zap-commons/src/main/java/br/com/softplan/security/zap/commons/ZapInfo.java) in its constructor and, optionally, an instance of [`AuthenticationInfo`](zap-client-api/src/main/java/br/com/softplan/security/zap/api/model/AuthenticationInfo.java) for analysis with authentication. `ZapClient` has only one public method: `analyze()`. This method starts a ZAP analysis and receives as parameter an instance of [`AnalysisInfo`](zap-client-api/src/main/java/br/com/softplan/security/zap/api/model/AnalysisInfo.java).

To use the API, one just needs to create those objects and call `analyze()`. The analysis output are the reports generated by ZAP, represented by an instance of the [`ZapReport`](zap-client-api/src/main/java/br/com/softplan/security/zap/api/report/ZapReport.java) class.

### ZapInfo

This class keeps all the necessary information regarding the ZAP instance that will be used. A builder is provided to make it easier to create objects with three main methods:

- `buildToUseRunningZap()`
- `buildToRunZap()`
- `buildToRunZapWithDocker()`

As it's clear by the methods' names, besides being possible to run an analysis with a running instance of ZAP, it's also possible to automatically start ZAP - via local installation or docker - to run the analysis. In these options, ZAP is also automatically finalized afterwhen the analysis ends.

Optionally, it's also possible to define the value of each parameter through the builder. Here are some examples:

```java
// To use an instance of ZAP that is already executing, it's only necessary to inform ZAP's host and port
ZapInfo runningZapInfo = ZapInfo.builder().buildToUseRunningZap("localhost", 8090);

// To automatically start ZAP, it's not necessary to inform the host, but it's required to pass directory where ZAP is installed
ZapInfo runZapInfo = ZapInfo.builder().buildToRunZap(8090, "C:\\ZAP");

// To run ZAP via Docker, Docker must be locally installed and the application must have permission to run Docker
ZapInfo dockerZapInfo = ZapInfo.builder().buildToRunZapWithDocker(8090);

// The attributes can also be manually defined (dockerZapInfo is equivalent to newDockerZapInfo, for instance)
ZapInfo newDockerZapInfo = ZapInfo.builder().port(8090).shouldRunWithDocker(true).build();

// The 'path' attribute is enough to make sure ZAP will be automatically started
ZapInfo newRunZapInfo = ZapInfo.builder().port(8090).path("C:\\ZAP").build(); // equivalent to runZapInfo

// Lastly, both strategies can be used together
ZapInfo runningZapInfoWithTimeout = ZapInfo.builder().initializationTimeoutInMillis(30000L).buildToRunZap(8090, "C:\\ZAP");
```

### AuthenticationInfo

Da mesma forma que `ZapInfo` armazena todas as informações necessárias referentes ao ZAP, `AuthenticationInfo` armazena todos os parâmetros
necessários para autenticação. De forma análoga, um builder também é disponibilizado para facilitar a criação dos objetos com dois métodos principais:

- `buildCasAuthenticationInfo()`
- `buildFormAuthenticationInfo()`

Esses métodos facilitam a criação de instâncias de `AuthenticationInfo` para cada um dos tipos de autenticação suportados: CAS e form. Ambos os métodos
recebem como parâmetro o mínimo necessário para cada tipo de autenticação, mas em geral será necessário fornecer parâmetros adicionais (para habilitar reautenticação, por exemplo).
Existem diversos parâmetros que podem ser utilizados para configurar a autenticação, seguem alguns exemplos explorando os casos mais comuns:

```java
// Na autenticação via form, os parâmetros obrigatórios são apenas loginUrl, username e password
AuthenticationInfo formInfo = AuthenticationInfo.builder()
        .buildFormAuthenticationInfo("http://myapp/login", "username", "password");

// Para autenticação via CAS, também é necessário informar uma página protegida para cada contexto que será analisado
// Essa página será acessada automaticamente após a autenticação e antes do scan do ZAP, evitando redirecionamentos durante o scan
AuthenticationInfo casInfo = AuthenticationInfo.builder()
        .buildCasAuthenticationInfo("http://myapp/login", "username", "password", "http://mydomain/myapp/protected/somePage");

// Para habilitar reautenticação (garantindo que toda a análise será autenticada), basta definir valores para loggedInRegex ou loggedOutRegex
AuthenticationInfo formReauthInfo = AuthenticationInfo.builder()
        .loggedInRegex("\\Q<a href=\"logout.jsp\">Logout</a>\\E")
        .buildFormAuthenticationInfo("http://myapp/login", "username", "password");

// É possível definir páginas que não serão scaneadas (útil para excluir páginas de logout, caso reautenticação não seja possível)
AuthenticationInfo formExcludeInfo = AuthenticationInfo.builder()
        .excludeFromScan("http://myapp/logout")
        .buildFormAuthenticationInfo("http://myapp/login", "username", "password");
```

### AnalysisInfo

Essa pequena classe armazena as informações referentes à análise:

- `targetUrl`: URL da aplicação que será scaneada;
- `analysisTimeoutInMinutes`: timeout da análise;
- `analysisType`: tipo da análise. Existem três tipos disponíveis: `WITH_SPIDER`, `WITH_AJAX_SPIDER` e `ACTIVE_SCAN_ONLY`.

Os tipos da análise estão definidos no enum
[`AnalysisType`](zap-client-api/src/main/java/br/com/softplan/security/zap/api/model/AnalysisType.java).
`WITH_SPIDER` é a análise padrão, que executa o [Spider do ZAP](https://github.com/zaproxy/zap-core-help/wiki/HelpStartConceptsSpider) antes do [Active Scan](https://github.com/zaproxy/zap-core-help/wiki/HelpStartConceptsAscan).
Para aplicações que utilizam AJAX, pode ser interessante executar o AJAX Spider disponível após o Spider padrão. O tipo `WITH_AJAX_SPIDER` define esse comportamento.
Por fim, `ACTIVE_SCAN_ONLY` executa apenas o Active Scan, para casos em que a navegação pela aplicação foi feita através de proxy com o ZAP via testes com o Selenium, por exemplo
(informações sobre esse tipo de estratégia são apresentadas na [página do projeto exemplo](zap-example#an%C3%A1lise-integrada-com-selenium)).

Todos os parâmetros são passados no construtor e o objeto criado é passado para o método `analyze` do `ZapClient`. Portanto,
é possível executar diferentes análises a partir de uma mesma instância de `ZapClient`.

### ZapReport

O retorno do `analyze()` é um objeto do tipo `ZapReport`. Através dele é possível acessar os relatórios gerados pelo ZAP.
Além disso, o ZAP Client API gera um novo relatório que apresenta as URLs visitadas pelo Spider.
Esse relatório é importante porque ele demonstra se o Spider conseguiu, de fato, navegar pela aplicação. Dependendo dos resultados, pode ser possível
concluir que a autenticação não funcionou corretamente, por exemplo.

## Examples

Execução de análise em um ZAP que já está em execução:

```java
ZapInfo zapInfo = ZapInfo.builder().buildToUseRunningZap("localhost", 8080);
ZapClient zapClient = new ZapClient(zapInfo);
ZapReport zapReport = zapClient.analyze(new AnalysisInfo("http://server17:8180/bodgeit", 120));

System.out.println(zapReport.getHtmlReportAsString());
System.out.println(zapReport.getHtmlSpiderResultsAsString());
```

Execução de análise iniciando o ZAP automaticamente com autenticação via CAS:

```java
ZapInfo zapInfo = ZapInfo.builder().buildToUseRunningZap("localhost", 8080);
AuthenticationInfo authenticationInfo = AuthenticationInfo.builder()
        .loggedOutRegex("\\QLocation: https://server119.softplan.com.br:8443/bouncer-server/\\E.*")
        .buildCasAuthenticationInfo(
            "https://server119.softplan.com.br:8443/bouncer-server/login", 
            "bob", 
            "foo", 
            "https://server119.softplan.com.br:8443/bouncer-mock-saj/protected/index.jsp"
        );
ZapClient zapClient = new ZapClient(zapInfo, authenticationInfo);
ZapReport zapReport = zapClient.analyze(new AnalysisInfo("http://server17:8180/bodgeit", 120));

System.out.println(zapReport.getHtmlReportAsString());
System.out.println(zapReport.getHtmlSpiderResultsAsString());
```

---
:zap:
